package com.example.scientificcalculator;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
import androidx.appcompat.app.AppCompatActivity;

public class MainActivity extends AppCompatActivity {

    private TextView displayText;
    private TextView operationText;
    private String currentDisplay = "0";
    private String previousValue = null;
    private String operation = null;
    private boolean newNumber = true;
    private boolean advancedMode = false;
    private boolean isDegreeMode = true; // true = DEG, false = RAD
    
    private View advancedPanel;
    private Button modeToggleButton;
    private Button angleModeButton;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // Initialize views
        displayText = findViewById(R.id.displayText);
        operationText = findViewById(R.id.operationText);
        advancedPanel = findViewById(R.id.advancedPanel);
        modeToggleButton = findViewById(R.id.modeToggleButton);
        angleModeButton = findViewById(R.id.angleModeButton);

        updateDisplay();
        updateAngleModeButton();
    }

    private void updateDisplay() {
        displayText.setText(currentDisplay);
        if (operation != null && previousValue != null) {
            operationText.setText(previousValue + " " + operation);
            operationText.setVisibility(View.VISIBLE);
        } else {
            operationText.setVisibility(View.GONE);
        }
    }

    // Number button handler
    public void onNumberClick(View view) {
        Button button = (Button) view;
        String number = button.getText().toString();
        
        if (newNumber) {
            currentDisplay = number;
            newNumber = false;
        } else {
            if (currentDisplay.equals("0")) {
                currentDisplay = number;
            } else {
                currentDisplay += number;
            }
        }
        updateDisplay();
    }

    // Decimal point handler
    public void onDecimalClick(View view) {
        if (newNumber) {
            currentDisplay = "0.";
            newNumber = false;
        } else if (!currentDisplay.contains(".")) {
            currentDisplay += ".";
        }
        updateDisplay();
    }

    // Operation buttons (+, -, ×, ÷)
    public void onOperationClick(View view) {
        Button button = (Button) view;
        String op = button.getText().toString();
        
        double current = Double.parseDouble(currentDisplay);
        
        if (previousValue != null && operation != null && !newNumber) {
            double result = calculate(Double.parseDouble(previousValue), current, operation);
            currentDisplay = formatResult(result);
            previousValue = String.valueOf(result);
        } else {
            previousValue = String.valueOf(current);
        }
        
        operation = op;
        newNumber = true;
        updateDisplay();
    }

    // Equals button
    public void onEqualsClick(View view) {
        if (operation != null && previousValue != null) {
            double current = Double.parseDouble(currentDisplay);
            double result = calculate(Double.parseDouble(previousValue), current, operation);
            currentDisplay = formatResult(result);
            previousValue = null;
            operation = null;
            newNumber = true;
            updateDisplay();
        }
    }

    // Clear button
    public void onClearClick(View view) {
        currentDisplay = "0";
        previousValue = null;
        operation = null;
        newNumber = true;
        updateDisplay();
    }

    // Backspace button
    public void onBackspaceClick(View view) {
        if (currentDisplay.length() > 1) {
            currentDisplay = currentDisplay.substring(0, currentDisplay.length() - 1);
        } else {
            currentDisplay = "0";
            newNumber = true;
        }
        updateDisplay();
    }

    // Plus/Minus toggle
    public void onPlusMinusClick(View view) {
        double value = Double.parseDouble(currentDisplay);
        currentDisplay = formatResult(-value);
        updateDisplay();
    }

    // Advanced function buttons
    public void onFunctionClick(View view) {
        Button button = (Button) view;
        String function = button.getTag().toString();
        
        double current = Double.parseDouble(currentDisplay);
        double result = 0;

        switch (function) {
            case "sqrt":
                result = Math.sqrt(current);
                break;
            case "square":
                result = Math.pow(current, 2);
                break;
            case "reciprocal":
                result = 1.0 / current;
                break;
            case "sin":
                result = isDegreeMode ? Math.sin(Math.toRadians(current)) : Math.sin(current);
                break;
            case "cos":
                result = isDegreeMode ? Math.cos(Math.toRadians(current)) : Math.cos(current);
                break;
            case "tan":
                result = isDegreeMode ? Math.tan(Math.toRadians(current)) : Math.tan(current);
                break;
            case "ln":
                result = Math.log(current);
                break;
            case "log":
                result = Math.log10(current);
                break;
            case "exp":
                result = Math.exp(current);
                break;
            case "pow10":
                result = Math.pow(10, current);
                break;
            case "pi":
                currentDisplay = formatResult(Math.PI);
                newNumber = true;
                updateDisplay();
                return;
            case "e":
                currentDisplay = formatResult(Math.E);
                newNumber = true;
                updateDisplay();
                return;
            case "factorial":
                result = factorial((int) current);
                break;
            case "power":
                onOperationClick(view);
                return;
        }

        currentDisplay = formatResult(result);
        newNumber = true;
        updateDisplay();
    }

    // Mode toggle button
    public void onModeToggleClick(View view) {
        advancedMode = !advancedMode;
        advancedPanel.setVisibility(advancedMode ? View.VISIBLE : View.GONE);
        modeToggleButton.setText(advancedMode ? "← Basic Mode" : "Advanced Mode →");
    }

    // Angle mode toggle (DEG/RAD)
    public void onAngleModeClick(View view) {
        isDegreeMode = !isDegreeMode;
        updateAngleModeButton();
    }

    private void updateAngleModeButton() {
        if (angleModeButton != null) {
            angleModeButton.setText(isDegreeMode ? "DEG" : "RAD");
        }
    }

    // Calculate based on operation
    private double calculate(double prev, double curr, String op) {
        switch (op) {
            case "+":
                return prev + curr;
            case "−":
                return prev - curr;
            case "×":
                return prev * curr;
            case "÷":
                return prev / curr;
            case "^":
                return Math.pow(prev, curr);
            default:
                return curr;
        }
    }

    // Format result to remove unnecessary decimals
    private String formatResult(double value) {
        if (Double.isNaN(value) || Double.isInfinite(value)) {
            return "Error";
        }
        if (value == (long) value) {
            return String.valueOf((long) value);
        } else {
            return String.valueOf(value);
        }
    }

    // Factorial calculation
    private double factorial(int n) {
        if (n < 0) return Double.NaN;
        if (n == 0 || n == 1) return 1;
        double result = 1;
        for (int i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }
}